import{r as l,m as ue,z as he,w as ve,j as e}from"./index-CWCk8Mfu.js";import{N as pe,Q as je}from"./NewCustomerModal-C6Nknmxk.js";import{a as j,c as g}from"./index.esm-CtJdof8l.js";import{f as A,h as xe}from"./api-helnlucg.js";import{u as ye,C as ge}from"./DefaultLayout-CWVqZZSL.js";import{C as P}from"./CRow-D5FXM-Wo.js";import{C as V}from"./CCol-DELpJvbl.js";import{C as be,a as fe}from"./CCardBody-CjD5VXLl.js";import{C as Ne}from"./CCardHeader-DfyZxt5z.js";import{C as _e}from"./CForm-CjIivhzA.js";import{C as u}from"./CFormInput-9pZ0Cm2L.js";import{C as Z}from"./cil-mobile-C0RpYdWd.js";import{C as p}from"./CFormLabel-C5kMTk4Z.js";import{C as b}from"./CFormSelect-010MiXJJ.js";import"./CModalTitle-C4XdBZVB.js";import"./CFormTextarea-C5z35aZe.js";var U=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='227.313 363.313 312 278.627 396.687 363.313 419.313 340.687 334.627 256 419.313 171.313 396.687 148.687 312 233.373 227.313 148.687 204.687 171.313 289.373 256 204.687 340.687 227.313 363.313' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M472,64H194.644a24.091,24.091,0,0,0-17.42,7.492L16,241.623v28.754L177.224,440.508A24.091,24.091,0,0,0,194.644,448H472a24.028,24.028,0,0,0,24-24V88A24.028,24.028,0,0,0,472,64Zm-8,352H198.084L48,257.623v-3.246L198.084,96H464Z' class='ci-primary'/>"],G=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='440 240 272 240 272 72 240 72 240 240 72 240 72 272 240 272 240 440 272 440 272 272 440 272 440 240' class='ci-primary'/>"];let J;const Be=()=>{var L,$,B;const[K,W]=l.useState(!1),[X,f]=l.useState(!1),[S,Ce]=l.useState(),[z,Y]=l.useState(),[T,k]=l.useState(),[x,ee]=l.useState(),[se,N]=l.useState(!1),ie=ue(),{showSpinner:Q,hideSpinner:D}=he(),_=()=>`${new Date().getHours()}:${new Date().getMinutes().toString().padStart(2,"0")}`,[r,m]=l.useState({customer_id:0,lat:"",long:"",payLater:!1,isSettled:!1,invoiceDate:new Date().toISOString().split("T")[0],deliveryTime:_(),deliveryDate:new Date().toISOString().split("T")[0],invoiceType:1,items:[{product_id:void 0,product_sizes_id:0,product_name:"",product_unit:"",product_local_name:"",size_name:"",size_local_name:"",oPrice:0,bPrice:0,dPrice:0,dQty:null,eQty:null,qty:null,total_price:0,returnable:0}],orderStatus:1,totalAmount:0,discount:0,balanceAmount:0,paidAmount:0,finalAmount:0,paymentType:0}),{showToast:h}=ve(),{t,i18n:te}=ye("global");te.language;const[d,F]=l.useState({}),[ae,y]=l.useState([]),ne=((i,s)=>function(...a){clearTimeout(J),J=setTimeout(()=>{i.apply(this,a)},s)})(async i=>{try{const s=await A("/api/searchCustomer?searchQuery="+i);s!=null&&s.length?y(s):y([])}catch(s){h("danger","Error occured "+s)}},750),ce=i=>{const s=i.target.value;F({name:s}),s?ne(s):y([])},q=i=>{F(i),m(a=>({...a,customer_id:i.id}));const s=I([...T],i.discount);k(s),C(s),y([]),le(i.id)},re=i=>{q(i),N(!1)},oe=(i,s)=>{const a=i.sizes[0].oPrice,o=a-a*(s||(d.discount??0))/100;return Math.round(o)},I=(i,s)=>(i.forEach(a=>{a.sizes[0].dPrice=oe(a,s)}),i),le=async i=>{try{const s=await A("/api/customerHistory?id="+i);s&&ee(s)}catch(s){h("danger","Error occured "+s)}},de=async()=>{Q();const i=await A("/api/product");D(),k(I([...i.filter(a=>a.show==1)]));const s=["Select Product"];s.push(...i.filter(a=>a.show==1).map(a=>({label:a.name,value:a.id,disabled:a.show===0}))),Y(s)},M=()=>{m(i=>{const s={...i};return s.items.push({product_id:void 0,product_sizes_id:0,product_name:"",product_unit:"",product_local_name:"",size_name:"",size_local_name:"",oPrice:0,dPrice:0,bPrice:0,qty:null,dQty:null,eQty:null,total_price:0,returnable:0}),{...s}})},C=i=>{let s=0;return i.forEach(a=>{s+=a.total_price}),s},E=i=>{m(s=>{const a={...s};return a.items.splice(i,1),{...a}})};l.useEffect(()=>{de()},[]);const w=i=>{i.finalAmount=i.totalAmount-(i.totalAmount*i.discount/100||0),i.balanceAmount=0,i.paidAmount=i.finalAmount},v=i=>{const{name:s,value:a}=i.target;m(s==="discount"?o=>{const n={...o};return n.discount=a,w(n),{...n}}:s==="paidAmount"?o=>{const n={...o};return n.paidAmount=a,n.balanceAmount=n.finalAmount-n.paidAmount,{...n}}:{...r,[s]:a})},R=(i,s)=>{const{value:a}=i.target,o=T.find(n=>n.id==a);o&&o.sizes[0]&&m(n=>{const c={...n};return c.items[s].product_id=a,c.items[s].id=a,c.items[s].product_sizes_id=o.sizes[0].id,c.items[s].name=o.sizes[0].name,c.items[s].localName=o.sizes[0].localName,c.items[s].unit=o.unit,c.items[s].product_name=o.name,c.items[s].size_name=o.sizes[0].name,c.items[s].size_local_name=o.sizes[0].localName,c.items[s].product_local_name=o.localName,c.items[s].oPrice=o.sizes[0].oPrice,c.items[s].dQty=null,c.items[s].eQty=null,c.items[s].dPrice=o.sizes[0].dPrice,c.items[s].bPrice=o.sizes[0].bPrice,c.items[s].returnable=o.sizes[0].returnable,c.items[s].total_price=o.sizes[0].dPrice*c.items[s].dQty,c.totalAmount=C(c.items),w(c),{...c}})},H=(i,s)=>{const{value:a}=i.target;m(o=>{const n={...o};return n.items[s].dQty=a,n.items[s].total_price=n.items[s].dPrice*n.items[s].dQty,n.totalAmount=C(n.items),w(n),{...n}})},me=async i=>{try{i.preventDefault(),i.stopPropagation();let s=!1;const a=r.invoiceType===1?1:2,o=r.finalAmount-r.paidAmount,n={...r,orderStatus:a,deliveryTime:_(),remainingBalance:o};if(n.customer_id===0&&(s=!0,h("warning","Please select or add a customer.")),n.paymentType===1&&n.paidAmount<=0&&(s=!0,h("warning","For online/UPI payment, paid amount must be greater than zero.")),(n.items.length===0||n.items.every(c=>c.dQty===0))&&(s=!0,h("warning","Please add at least one product with a quantity greater than zero.")),s)W(!0);else{Q();const c=await xe("/api/order",n);c&&(O(),c.id?(h("success",a===1?"Order is delivered.":"Order is created as pending (Advanced Booking)."),n.paymentType===1&&f(!0),ie("/invoice-details/"+c.id)):h("danger","Error occurred while processing the order."))}}catch{h("danger","Error while placing the order.")}finally{D()}},O=async()=>{m({customer_id:0,lat:"",long:"",payLater:!1,isSettled:!1,invoiceDate:new Date().toISOString().split("T")[0],deliveryTime:_(),deliveryDate:new Date().toISOString().split("T")[0],invoiceType:1,items:[{product_id:void 0,product_sizes_id:0,product_name:"",product_unit:"",product_local_name:"",size_name:"",size_local_name:"",oPrice:0,dPrice:0,bPrice:0,qty:null,total_price:0}],totalAmount:0,discount:0,balanceAmount:0,paidAmount:0,finalAmount:0,paymentType:1})};return e.jsxs(P,{children:[e.jsx(pe,{hint:d.name,onSuccess:re,visible:se,setVisible:N}),e.jsx(je,{visible:X,setVisible:f}),e.jsx(V,{xs:12,children:e.jsxs(be,{className:"mb-4",children:[e.jsx(Ne,{children:e.jsx("strong",{children:t("invoice.new_invoice")})}),e.jsx(fe,{children:e.jsxs(_e,{noValidate:!0,validated:K,onSubmit:me,children:[e.jsx("div",{className:"row mb-2",children:e.jsxs("div",{className:"col-9",children:[e.jsx(u,{type:"text",id:"pname",placeholder:t("invoice.customer_name"),name:"customerName",value:d.name,onChange:ce,autoComplete:"off",required:!0}),((L=d.name)==null?void 0:L.length)>0&&e.jsxs("ul",{className:"suggestions-list",children:[ae.map((i,s)=>e.jsx("li",{onClick:()=>q(i),children:i.name+" ("+i.mobile+")"},s)),!d.id&&e.jsx("li",{children:e.jsx(ge,{role:"button",color:"danger",onClick:()=>N(!0),children:t("invoice.new_customer")})})]})]})}),d.id&&e.jsx("div",{className:"row",children:e.jsx("div",{className:"col-sm-12 mt-1",children:e.jsx(Z,{color:"success",children:e.jsxs("p",{children:[e.jsxs("strong",{children:[t("invoice.name"),":"]})," ",d.name," (",d.mobile,") ",e.jsx("br",{}),d.address&&e.jsxs(e.Fragment,{children:[e.jsxs("strong",{children:[t("invoice.address"),": "]})," ",d.address]}),x&&e.jsxs(e.Fragment,{children:[x.pendingPayment>0&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),t("invoice.credit")," ",e.jsx("strong",{className:"text-danger",children:x.pendingPayment})," ",t("invoice.rs")]}),x.pendingPayment<0&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),t("invoice.balance")," (",t("invoice.advance"),")"," ",e.jsx("strong",{className:"text-success",children:x.pendingPayment*-1})," ",t("invoice.rs")]}),x.returnEmptyProducts.filter(i=>i.quantity>0).map(i=>e.jsxs(e.Fragment,{children:[e.jsx("br",{}),t("invoice.collect")," ",e.jsxs("strong",{className:"text-danger",children:[" ",i.quantity," "]})," ",t("invoice.empty")," ",e.jsxs("strong",{className:"text-danger",children:[" ",i.product_name," "]})]}))]})]})})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"invoiceType",children:t("invoice.invoice_type")}),e.jsx(b,{"aria-label":t("invoice.select_invoice_type"),name:"invoiceType",value:r.invoiceType,options:[{label:t("invoice.regular"),value:1},{label:t("invoice.advance_booking"),value:2}],onChange:v,required:!0,feedbackInvalid:t("invoice.select_type")})]})}),e.jsx("div",{className:"col-sm-4",children:e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"invoiceDate",children:t("invoice.invoice_date")}),e.jsx(u,{type:"date",id:"invoiceDate",placeholder:t("invoice.pune"),name:"invoiceDate",value:r.invoiceDate,onChange:v,required:!0,feedbackInvalid:t("invoice.select_date")})]})}),e.jsx("div",{className:"col-sm-4",children:r.invoiceType==2&&e.jsxs("div",{className:"mb-3",children:[e.jsx(p,{htmlFor:"deliveryDate",children:t("invoice.delivery_date")}),e.jsx(u,{type:"date",id:"deliveryDate",placeholder:t("invoice.pune"),name:"deliveryDate",value:r.deliveryDate,onChange:v,required:r.invoiceType==2,feedbackInvalid:t("invoice.select_date")})]})})]}),e.jsxs("div",{className:"d-none d-md-block",children:[e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-4",children:e.jsx("b",{children:t("invoice.product")})}),e.jsx("div",{className:"col-2",children:e.jsx("b",{children:t("invoice.price")})}),e.jsx("div",{className:"col-2",children:e.jsx("b",{children:t("invoice.quantity")})}),e.jsx("div",{className:"col-2",children:e.jsx("b",{children:t("invoice.total")})}),e.jsx("div",{className:"col-2",children:e.jsx("b",{children:t("invoice.action")})})]}),($=r.items)==null?void 0:$.map((i,s)=>e.jsx("div",{className:"bg-light rounded p-3 my-2",children:e.jsxs("div",{className:"row align-items-center",children:[e.jsx("div",{className:"col-4",children:e.jsx(b,{"aria-label":t("invoice.select_product"),value:i.product_id,options:z,onChange:()=>R(event,s),invalid:i.notSelected==!0,required:!0,feedbackInvalid:t("invoice.select_product")})}),e.jsx("div",{className:"col-2",children:e.jsx("p",{children:i.dPrice+(i.unit?" / "+i.unit:"")})}),e.jsx("div",{className:"col-2",children:e.jsx(u,{type:"number",value:i.dQty,invalid:i.invalidQty==!0,required:!0,feedbackInvalid:`${t("invoice.max")} ${i.stockQty}`,onChange:()=>H(event,s)})}),e.jsx("div",{className:"col-2",children:e.jsx("p",{children:i.total_price})}),e.jsxs("div",{className:"col-2 d-flex",children:[r.items.length>1&&e.jsx(j,{color:"",onClick:()=>E(s),children:e.jsx(g,{icon:U,size:"xl",style:{"--ci-primary-color":"red"}})}),s===r.items.length-1&&e.jsx(j,{onClick:M,color:"",children:e.jsx(g,{icon:G,size:"xl",style:{"--ci-primary-color":"green"}})})]})]})},s))]}),e.jsx("div",{className:"d-block d-md-none",children:(B=r.items)==null?void 0:B.map((i,s)=>e.jsxs("div",{className:"bg-light rounded p-3 my-3",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"font-weight-bold",children:t("invoice.product")}),e.jsx(b,{"aria-label":t("invoice.select_product"),value:i.product_id,options:z,onChange:()=>R(event,s),invalid:i.notSelected==!0,required:!0,feedbackInvalid:t("invoice.select_product")})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"font-weight-bold",children:t("invoice.price")}),e.jsx("p",{children:i.dPrice+(i.unit?" / "+i.unit:"")})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"font-weight-bold",children:t("invoice.quantity")}),e.jsx(u,{type:"number",value:i.dQty,invalid:i.invalidQty==!0,required:!0,feedbackInvalid:`${t("invoice.max")} ${i.stockQty}`,onChange:()=>H(event,s)})]}),e.jsxs("div",{className:"row align-items-center",children:[e.jsxs("div",{className:"col-6",children:[e.jsx("label",{className:"font-weight-bold",children:t("invoice.total")}),e.jsx("p",{children:i.total_price})]}),e.jsxs("div",{className:"col-6 d-flex justify-content-start",children:[r.items.length>1&&e.jsx(j,{color:"",onClick:()=>E(s),children:e.jsx(g,{icon:U,size:"xl",style:{"--ci-primary-color":"red"}})}),s===r.items.length-1&&e.jsx(j,{onClick:M,color:"",children:e.jsx(g,{icon:G,size:"xl",style:{"--ci-primary-color":"green"}})})]})]})]},s))}),e.jsxs("div",{className:"row d-none d-md-flex align-items-center",children:[e.jsx("div",{className:"col-6"}),e.jsx("div",{className:"col-2",children:e.jsx("b",{children:t("invoice.total")})}),e.jsx("div",{className:"col-2",children:r.totalAmount}),e.jsx("div",{className:"col-2"})]}),e.jsx("div",{className:"d-block d-md-none bg-light rounded p-3 my-3",children:e.jsxs("div",{className:"row align-items-center",children:[e.jsx("div",{className:"col-6",children:e.jsx("b",{children:t("invoice.total")})}),e.jsx("div",{className:"col-6 text-right",children:r.totalAmount})]})}),e.jsx("div",{children:e.jsx(P,{children:e.jsxs(V,{xs:12,md:6,children:[e.jsx(p,{htmlFor:"paymentType",children:t("invoice.payment_type")}),e.jsxs(b,{id:"paymentType",name:"paymentType",value:r.paymentType,onChange:v,children:[e.jsx("option",{value:0,children:t("invoice.cash")}),e.jsx("option",{value:1,children:t("invoice.online")})]})]})})}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"discount",children:[t("invoice.discount")," (%)"]}),e.jsx(u,{type:"number",id:"discount",placeholder:"0",name:"discount",value:r.discount===0?"":r.discount,onChange:i=>{const s=i.target.value===""?"":Math.max(0,Math.min(100,i.target.value));v({target:{name:"discount",value:s}})}})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"paidAmount",children:[t("invoice.paid_amount")," (Rs)"]}),e.jsx(u,{type:"number",id:"paidAmount",placeholder:"",name:"paidAmount",value:r.paidAmount,onChange:v})]})}),e.jsx("div",{className:"col-sm-3",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"paidAmount",children:[t("invoice.balance_amount")," (Rs)"]}),e.jsx(u,{type:"number",id:"balanceAmount",placeholder:"",readOnly:!0,name:"balanceAmount",value:r.balanceAmount,onChange:v})]})}),e.jsx("div",{className:"col-sm-2",children:e.jsxs("div",{className:"mb-3",children:[e.jsxs(p,{htmlFor:"finalAmount",children:[t("invoice.final_amount")," (Rs)"]}),e.jsx(u,{type:"number",id:"finalAmount",placeholder:"",name:"finalAmount",readOnly:!0,value:r.finalAmount,onChange:v})]})})]}),e.jsx("div",{children:S&&e.jsx(P,{children:e.jsx(Z,{color:"danger",children:S})})}),e.jsxs("div",{className:"mb-3 mt-3",children:[e.jsx(j,{color:"success",type:"submit",children:t("invoice.submit")})," ",e.jsx(j,{color:"secondary",onClick:O,children:t("invoice.clear")})," ",r.paymentType==1&&e.jsx(j,{className:"mr-20",type:"button",onClick:()=>f(!0),color:"primary",children:t("invoice.view_qr")})]})]})})]})})]})};export{Be as default};
